> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [zhuanlan.zhihu.com](https://zhuanlan.zhihu.com/p/24863977)

> 本文承接上篇 https://zhuanlan.zhihu.com/p/24709748，来讲矩阵对矩阵的求导术。使用小写字母x表示标量，粗体小写字母\boldsymbol{x} 表示列向量，大写字母X表示矩阵。矩阵对矩阵的求导采用了向量化的思路，常应…

本文承接上篇 [https://zhuanlan.zhihu.com/p/24709748](https://zhuanlan.zhihu.com/p/24709748)，来讲矩阵对矩阵的求导术。使用小写字母 x 表示标量，粗体小写字母![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bx%7D+)表示列向量，大写字母 X 表示矩阵。矩阵对矩阵的求导采用了向量化的思路，常应用于二阶方法中 Hessian 矩阵的分析。

首先来琢磨一下定义。矩阵对矩阵的导数，需要什么样的定义？第一，矩阵 F(p×q) 对矩阵 X(m×n) 的导数应包含所有 mnpq 个偏导数![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F_%7Bkl%7D%7D%7B%5Cpartial+X_%7Bij%7D%7D)，从而不损失信息；第二，导数与微分有简明的联系，因为在计算导数和应用中需要这个联系；第三，导数有简明的从整体出发的算法。我们先定义向量![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bf%7D) (p×1) 对向量![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bx%7D) (m×1) 的导数![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D+%3D+%5Cbegin%7Bbmatrix%7D+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_1%7D+%26+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_1%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_1%7D%5C%5C+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_2%7D+%26+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_2%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_2%7D%5C%5C+%5Cvdots+%26+%5Cvdots+%26+%5Cddots+%26+%5Cvdots%5C%5C+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_m%7D+%26+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_m%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_m%7D%5C%5C+%5Cend%7Bbmatrix%7D) (m×p)，有![](https://www.zhihu.com/equation?tex=d%5Cboldsymbol%7Bf%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D+%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D+%7D%5ET+d%5Cboldsymbol%7Bx%7D+)；再定义矩阵的（按列优先）向量化![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28X%29+%3D+%5BX_%7B11%7D%2C+%5Cldots%2C+X_%7Bm1%7D%2C+X_%7B12%7D%2C+%5Cldots%2C+X_%7Bm2%7D%2C+%5Cldots%2C+X_%7B1n%7D%2C+%5Cldots%2C+X_%7Bmn%7D%5D%5ET) (mn×1)，并定义矩阵 F 对矩阵 X 的导数![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28F%29%7D%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28X%29%7D) (mn×pq)。导数与微分有联系![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D%5ET+%5Cmathrm%7Bvec%7D%28dX%29)。几点说明如下：

1.  按此定义，标量 f 对矩阵 X(m×n) 的导数![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+f%7D%7B%5Cpartial+X%7D)是 mn×1 向量，与上篇的定义不兼容，不过二者容易相互转换。为避免混淆，用记号![](https://www.zhihu.com/equation?tex=%5Cnabla_X+f)表示上篇定义的 m×n 矩阵，则有![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+f%7D%7B%5Cpartial+X%7D%3D%5Cmathrm%7Bvec%7D%28%5Cnabla_X+f%29)。虽然本篇的技术可以用于标量对矩阵求导这种特殊情况，但使用上篇中的技术更方便。读者可以通过上篇中的算例试验两种方法的等价转换。  
    
2.  标量对矩阵的二阶导数，又称 Hessian 矩阵，定义为![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_X+f+%3D+%5Cfrac%7B%5Cpartial%5E2+f%7D%7B%5Cpartial+X%5E2%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cnabla_X+f%7D%7B%5Cpartial+X%7D) (mn×mn)，是对称矩阵。对向量![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+f%7D%7B%5Cpartial+X%7D)或矩阵![](https://www.zhihu.com/equation?tex=%5Cnabla_X+f)求导都可以得到 Hessian 矩阵，但从矩阵![](https://www.zhihu.com/equation?tex=%5Cnabla_X+f)出发更方便。
3.  ![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cfrac%7B%5Cpartial%5Cmathrm%7Bvec%7D+%28F%29%7D%7B%5Cpartial+X%7D+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28X%29%7D+%3D+%5Cfrac%7B%5Cpartial%5Cmathrm%7Bvec%7D%28F%29%7D%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28X%29%7D)，求导时矩阵被向量化，弊端是这在一定程度破坏了矩阵的结构，会导致结果变得形式复杂；好处是多元微积分中关于梯度、Hessian 矩阵的结论可以沿用过来，只需将矩阵向量化。例如优化问题中，牛顿法的更新![](https://www.zhihu.com/equation?tex=%5CDelta+X)，满足**![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28%5CDelta+X%29+%3D+-%28%5Cnabla%5E2_X+f%29%5E%7B-1%7D%5Cmathrm%7Bvec%7D%28%5Cnabla_X+f%29)。**
4.  在资料中，矩阵对矩阵的导数还有其它定义，比如![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cleft%5B%5Cfrac%7B%5Cpartial+F_%7Bkl%7D%7D%7B%5Cpartial+X%7D%5Cright%5D) (mp×nq)，或是![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cleft%5B%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X_%7Bij%7D%7D%5Cright%5D) (mp×nq)，它能兼容上篇中的标量对矩阵导数的定义，但微分与导数的联系（dF 等于![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D)中逐个 m×n 子块分别与 dX 做内积）不够简明，不便于计算和应用。资料 [5] 综述了以上定义，并批判它们是坏的定义，能配合微分运算的才是好的定义。
5.  在资料中，有分子布局和分母布局两种定义，其中向量对向量的导数的排布有所不同。本文使用的是分母布局，机器学习和优化中的梯度矩阵采用此定义。而控制论等领域中的 Jacobian 矩阵采用分子布局，向量![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bf%7D)对向量![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bx%7D)的导数定义是![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D+%3D+%5Cbegin%7Bbmatrix%7D+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_1%7D+%26+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_2%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_1%7D%7B%5Cpartial+x_m%7D%5C%5C+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_1%7D+%26+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_2%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_2%7D%7B%5Cpartial+x_m%7D%5C%5C+%5Cvdots+%26+%5Cvdots+%26+%5Cddots+%26+%5Cvdots%5C%5C+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_1%7D+%26+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_2%7D+%26+%5Ccdots+%26+%5Cfrac%7B%5Cpartial+f_p%7D%7B%5Cpartial+x_m%7D%5C%5C+%5Cend%7Bbmatrix%7D)，对应地导数与微分的联系是![](https://www.zhihu.com/equation?tex=d%5Cboldsymbol%7Bf%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D+%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D++d%5Cboldsymbol%7Bx%7D+)；同样通过向量化定义矩阵 F 对矩阵 X 的导数![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28F%29%7D%7B%5Cpartial+%5Cmathrm%7Bvec%7D%28X%29%7D)，有![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%5Cmathrm%7Bvec%7D%28dX%29)。两种布局下的导数互为转置，二者求微分的步骤是相同的，仅在对照导数与微分的联系时有一个转置的区别，读者可根据所在领域的习惯选定一种布局。

然后来建立运算法则。仍然要利用导数与微分的联系![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D%5ET+%5Cmathrm%7Bvec%7D%28dX%29)，求微分的方法与上篇相同，而从微分得到导数需要一些向量化的技巧：

1.  线性：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28A%2BB%29+%3D+%5Cmathrm%7Bvec%7D%28A%29+%2B+%5Cmathrm%7Bvec%7D%28B%29)。
2.  矩阵乘法：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28AXB%29+%3D+%28B%5ET+%5Cotimes+A%29+%5Cmathrm%7Bvec%7D%28X%29)，其中![](https://www.zhihu.com/equation?tex=%5Cotimes)表示 Kronecker 积，A(m×n) 与 B(p×q) 的 Kronecker 积是![](https://www.zhihu.com/equation?tex=A%5Cotimes+B+%3D+%5BA_%7Bij%7DB%5D) (mp×nq)。此式证明见张贤达《矩阵分析与应用》第 107-108 页。
3.  转置：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28A%5ET%29+%3D+K_%7Bmn%7D%5Cmathrm%7Bvec%7D%28A%29)，A 是 m×n 矩阵，其中![](https://www.zhihu.com/equation?tex=K_%7Bmn%7D) (mn×mn) 是交换矩阵 (commutation matrix)，将按列优先的向量化变为按行优先的向量化。例如![](https://www.zhihu.com/equation?tex=K_%7B22%7D+%3D+%5Cbegin%7Bbmatrix%7D1+%26+0+%26+0%26+0+%5C%5C+0%26+0%26+1%26+0+%5C%5C+0%26+1%26+0%26+0+%5C%5C+0%26+0+%260+%26+1%5Cend%7Bbmatrix%7D%2C+%5Ctext%7Bvec%7D%28A%5ET%29%3D+%5Cbegin%7Bbmatrix%7D+A_%7B11%7D+%5C%5C+A_%7B12%7D+%5C%5C+A_%7B21%7D+%5C%5C+A_%7B22%7D%5Cend%7Bbmatrix%7D%2C+%5Ctext%7Bvec%7D%28A%29%3D%5Cbegin%7Bbmatrix%7D+A_%7B11%7D+%5C%5C+A_%7B21%7D+%5C%5C+A_%7B12%7D+%5C%5C+A_%7B22%7D%5Cend%7Bbmatrix%7D)。
4.  逐元素乘法：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28A%5Codot+X%29+%3D+%5Cmathrm%7Bdiag%7D%28A%29%5Cmathrm%7Bvec%7D%28X%29)，其中![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bdiag%7D%28A%29) (mn×mn) 是用 A 的元素（按列优先）排成的对角阵。

观察一下可以断言，**若矩阵函数 F 是矩阵 X 经加减乘法、逆、行列式、逐元素函数等运算构成，则使用相应的运算法则对 F 求微分，再做向量化并使用技巧将其它项交换至 vec(dX) 左侧，对照导数与微分的联系![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D%5ET+%5Cmathrm%7Bvec%7D%28dX%29)，即能得到导数。**

**特别地，若矩阵退化为向量，对照导数与微分的联系**![](https://www.zhihu.com/equation?tex=d%5Cboldsymbol%7Bf%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D+%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D+%7D%5ET+d%5Cboldsymbol%7Bx%7D+)**，即能得到导数。**

再谈一谈复合：假设已求得![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+Y%7D)，而 Y 是 X 的函数，如何求![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D)呢？从导数与微分的联系入手，![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+Y%7D%5ET%5Cmathrm%7Bvec%7D%28dY%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+Y%7D%5ET%5Cfrac%7B%5Cpartial+Y%7D%7B%5Cpartial+X%7D%5ET%5Cmathrm%7Bvec%7D%28dX%29+)，可以推出链式法则![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%5Cfrac%7B%5Cpartial+Y%7D%7B%5Cpartial+X%7D%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+Y%7D)。

和标量对矩阵的导数相比，矩阵对矩阵的导数形式更加复杂，从不同角度出发常会得到形式不同的结果。有一些 Kronecker 积和交换矩阵相关的恒等式，可用来做等价变形：

1.  ![](https://www.zhihu.com/equation?tex=%28A%5Cotimes+B%29%5ET+%3D+A%5ET+%5Cotimes+B%5ET)。
2.  ![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28%5Cboldsymbol%7Bab%7D%5ET%29+%3D+%5Cboldsymbol%7Bb%7D%5Cotimes%5Cboldsymbol%7Ba%7D)。
3.  ![](https://www.zhihu.com/equation?tex=%28A%5Cotimes+B%29%28C%5Cotimes+D%29+%3D+%28AC%29%5Cotimes+%28BD%29)。可以对![](https://www.zhihu.com/equation?tex=F+%3D+D%5ETB%5ETXAC)求导来证明，一方面，直接求导得到![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%28AC%29+%5Cotimes+%28BD%29)；另一方面，引入![](https://www.zhihu.com/equation?tex=Y+%3D+B%5ET+X+A)，有![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+Y%7D+%3D+C+%5Cotimes+D%2C+%5Cfrac%7B%5Cpartial+Y%7D%7B%5Cpartial+X%7D+%3D+A+%5Cotimes+B)，用链式法则得到![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%28A%5Cotimes+B%29%28C+%5Cotimes+D%29)。
4.  ![](https://www.zhihu.com/equation?tex=K_%7Bmn%7D+%3D+K_%7Bnm%7D%5ET%2C+K_%7Bmn%7DK_%7Bnm%7D+%3D+I)。
5.  ![](https://www.zhihu.com/equation?tex=K_%7Bpm%7D%28A%5Cotimes+B%29+K_%7Bnq%7D+%3D+B%5Cotimes+A)，A 是 m×n 矩阵，B 是 p×q 矩阵。可以对![](https://www.zhihu.com/equation?tex=AXB%5ET)做向量化来证明，一方面，![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28AXB%5ET%29+%3D+%28B%5Cotimes+A%29%5Cmathrm%7Bvec%7D%28X%29)；另一方面，![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28AXB%5ET%29+%3D+K_%7Bpm%7D%5Cmathrm%7Bvec%7D%28BX%5ETA%5ET%29+%3D+K_%7Bpm%7D%28A%5Cotimes+B%29%5Cmathrm%7Bvec%7D%28X%5ET%29+%3D+K_%7Bpm%7D%28A%5Cotimes+B%29+K_%7Bnq%7D%5Cmathrm%7Bvec%7D%28X%29)。

接下来演示一些算例。

例 1：![](https://www.zhihu.com/equation?tex=F+%3D+AX)，X 是 m×n 矩阵，求![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D)。

解：先求微分：![](https://www.zhihu.com/equation?tex=dF%3DAdX)，再做向量化，使用矩阵乘法的技巧，注意在 dX 右侧添加单位阵：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cmathrm%7Bvec%7D%28AdX%29+%3D+%28I_n%5Cotimes+A%29%5Cmathrm%7Bvec%7D%28dX%29)，对照导数与微分的联系得到![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+I_n%5Cotimes+A%5ET)。

特例：如果 X 退化为向量，即![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bf%7D+%3D+A+%5Cboldsymbol%7Bx%7D)，则根据向量的导数与微分的关系![](https://www.zhihu.com/equation?tex=d%5Cboldsymbol%7Bf%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D%5ET+d%5Cboldsymbol%7Bx%7D)，得到![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D+%3D+A%5ET)。

例 2：![](https://www.zhihu.com/equation?tex=f+%3D+%5Clog+%7CX%7C+)，X 是 n×n 矩阵，求![](https://www.zhihu.com/equation?tex=%5Cnabla_X+f)和![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_X+f)。

解：使用上篇中的技术可求得![](https://www.zhihu.com/equation?tex=%5Cnabla_X+f+%3D+X%5E%7B-1T%7D+)。为求![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_X+f)，先求微分：![](https://www.zhihu.com/equation?tex=d%5Cnabla_X+f+%3D+-%28X%5E%7B-1%7DdXX%5E%7B-1%7D%29%5ET)，再做向量化，使用转置和矩阵乘法的技巧![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28d%5Cnabla_X+f%29%3D+-K_%7Bnn%7D%5Cmathrm%7Bvec%7D%28X%5E%7B-1%7DdX+X%5E%7B-1%7D%29+%3D+-K_%7Bnn%7D%28X%5E%7B-1T%7D%5Cotimes+X%5E%7B-1%7D%29%5Cmathrm%7Bvec%7D%28dX%29)，对照导数与微分的联系，得到![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_X+f+%3D+-K_%7Bnn%7D%28X%5E%7B-1T%7D%5Cotimes+X%5E%7B-1%7D%29)，注意它是对称矩阵。在![](https://www.zhihu.com/equation?tex=X)是对称矩阵时，可简化为![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_X+f+%3D+-X%5E%7B-1%7D%5Cotimes+X%5E%7B-1%7D)。

例 3：![](https://www.zhihu.com/equation?tex=F+%3D+A%5Cexp%28XB%29)，A 是 l×m 矩阵，X 是 m×n 矩阵，B 是 n×p 矩阵，exp 为逐元素函数，求![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D)。

解：先求微分：![](https://www.zhihu.com/equation?tex=dF+%3D+A%28%5Cexp%28XB%29%5Codot+%28dXB%29%29)，再做向量化，使用矩阵乘法的技巧：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%28I_p%5Cotimes+A%29%5Cmathrm%7Bvec%7D%28%5Cexp%28XB%29%5Codot+%28dXB%29%29)，再用逐元素乘法的技巧：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%28I_p+%5Cotimes+A%29+%5Cmathrm%7Bdiag%7D%28%5Cexp%28XB%29%29%5Cmathrm%7Bvec%7D%28dXB%29)，再用矩阵乘法的技巧：![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%28I_p%5Cotimes+A%29%5Cmathrm%7Bdiag%7D%28%5Cexp%28XB%29%29%28B%5ET%5Cotimes+I_m%29%5Cmathrm%7Bvec%7D%28dX%29)，对照导数与微分的联系得到![](https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D+%3D+%28B%5Cotimes+I_m%29%5Cmathrm%7Bdiag%7D%28%5Cexp%28XB%29%29%28I_p%5Cotimes+A%5ET%29)。

例 4【一元 logistic 回归】：![](https://www.zhihu.com/equation?tex=l+%3D+-y+%5Cboldsymbol%7Bx%7D%5ET+%5Cboldsymbol%7Bw%7D+%2B+%5Clog%281+%2B+%5Cexp%28%5Cboldsymbol%7Bx%7D%5ET%5Cboldsymbol%7Bw%7D%29%29)，求![](https://www.zhihu.com/equation?tex=%5Cnabla_%5Cboldsymbol%7Bw%7D+l)和![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_%5Cboldsymbol%7Bw%7D+l)。其中![](https://www.zhihu.com/equation?tex=y)是取值 0 或 1 的标量，![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bx%7D%2C%5Cboldsymbol%7Bw%7D)是![](https://www.zhihu.com/equation?tex=n%C3%971)列向量。

解：使用上篇中的技术可求得![](https://www.zhihu.com/equation?tex=%5Cnabla_%5Cboldsymbol%7Bw%7D+l+%3D+%5Cboldsymbol%7Bx%7D%28%5Csigma%28%5Cboldsymbol%7Bx%7D%5ET%5Cboldsymbol%7Bw%7D%29+-+y%29)，其中![](https://www.zhihu.com/equation?tex=%5Csigma%28a%29+%3D+%5Cfrac%7B%5Cexp%28a%29%7D%7B1%2B%5Cexp%28a%29%7D) 为 sigmoid 函数。为求![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_%5Cboldsymbol%7Bw%7D+l)，先求微分：![](https://www.zhihu.com/equation?tex=d%5Cnabla_%5Cboldsymbol%7Bw%7D+l+%3D+%5Cboldsymbol%7Bx%7D+%5Csigma%27%28%5Cboldsymbol%7Bx%7D%5ET%5Cboldsymbol%7Bw%7D%29%5Cboldsymbol%7Bx%7D%5ET+d%5Cboldsymbol%7Bw%7D+)，其中![](https://www.zhihu.com/equation?tex=%5Csigma%27%28a%29+%3D+%5Cfrac%7B%5Cexp%28a%29%7D%7B%281%2B%5Cexp%28a%29%29%5E2%7D)为 sigmoid 函数的导数，对照导数与微分的联系，得到![](https://www.zhihu.com/equation?tex=%5Cnabla_w%5E2+l+%3D+%5Cboldsymbol%7Bx%7D%5Csigma%27%28%5Cboldsymbol%7Bx%7D%5ET%5Cboldsymbol%7Bw%7D%29%5Cboldsymbol%7Bx%7D%5ET)。

推广：样本![](https://www.zhihu.com/equation?tex=%28%5Cboldsymbol%7Bx%7D_1%2C+y_1%29%2C+%5Cdots%2C+%28%5Cboldsymbol%7Bx%7D_N%2Cy_N%29)，![](https://www.zhihu.com/equation?tex=l+%3D+%5Csum_%7Bi%3D1%7D%5EN+%5Cleft%28-y_i+%5Cboldsymbol%7Bx%7D_i%5ET%5Cboldsymbol%7Bw%7D+%2B+%5Clog%281%2B%5Cexp%28%5Cboldsymbol%7Bx_i%7D%5ET%5Cboldsymbol%7Bw%7D%29%29%5Cright%29)，求![](https://www.zhihu.com/equation?tex=%5Cnabla_w+l)和![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_w+l)。有两种方法，解 1：先对每个样本求导，然后相加；解 2：定义矩阵![](https://www.zhihu.com/equation?tex=X+%3D+%5Cbegin%7Bbmatrix%7D%5Cboldsymbol%7Bx%7D_1%5ET+%5C%5C+%5Cvdots+%5C%5C+%5Cboldsymbol%7Bx%7D_N%5ET+%5Cend%7Bbmatrix%7D)，向量![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7By%7D+%3D+%5Cbegin%7Bbmatrix%7Dy_1+%5C%5C+%5Cvdots+%5C%5C+y_N%5Cend%7Bbmatrix%7D)，将![](https://www.zhihu.com/equation?tex=l)写成矩阵形式![](https://www.zhihu.com/equation?tex=l+%3D+-%5Cboldsymbol%7By%7D%5ET+X%5Cboldsymbol%7Bw%7D+%2B+%5Cboldsymbol%7B1%7D%5ET%5Clog%28%5Cboldsymbol%7B1%7D+%2B+%5Cexp%28X%5Cboldsymbol%7Bw%7D%29%29)，进而可以使用上篇中的技术求得![](https://www.zhihu.com/equation?tex=%5Cnabla_%5Cboldsymbol%7Bw%7D+l+%3D+X%5ET%28%5Csigma%28X%5Cboldsymbol%7Bw%7D%29+-+%5Cboldsymbol%7By%7D%29)。为求![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_%5Cboldsymbol%7Bw%7D+l)，先求微分，再用逐元素乘法的技巧：![](https://www.zhihu.com/equation?tex=d%5Cnabla_%5Cboldsymbol%7Bw%7D+l+%3D+X%5ET+%28%5Csigma%27%28X%5Cboldsymbol%7Bw%7D%29%5Codot+%28X+d%5Cboldsymbol%7Bw%7D%29%29+%3D+X%5ET+%5Ctext%7Bdiag%7D%28%5Csigma%27%28X%5Cboldsymbol%7Bw%7D%29%29Xd%5Cboldsymbol%7Bw%7D)，对照导数与微分的联系，得到![](https://www.zhihu.com/equation?tex=%5Cnabla_w%5E2+l+%3D+X%5ET%5Ctext%7Bdiag%7D%28%5Csigma%27%28X%5Cboldsymbol%7Bw%7D%29%29X)。

例 5【多元 logistic 回归】：![](https://www.zhihu.com/equation?tex=l+%3D+-%5Cboldsymbol%7By%7D%5ET%5Clog+%5Ctext%7Bsoftmax%7D%28W%5Cboldsymbol%7Bx%7D%29+%3D+-%5Cboldsymbol%7By%7D%5ETW%5Cboldsymbol%7Bx%7D+%2B+%5Clog%28%5Cboldsymbol%7B1%7D%5ET%5Cexp%28W%5Cboldsymbol%7Bx%7D%29%29)，求![](https://www.zhihu.com/equation?tex=%5Cnabla_W+l)和![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_W+l+)。其中其中![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7By%7D)是除一个元素为 1 外其它元素为 0 的![](https://www.zhihu.com/equation?tex=m%C3%971)列向量，![](https://www.zhihu.com/equation?tex=W)是![](https://www.zhihu.com/equation?tex=m%5Ctimes+n)矩阵，![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Bx%7D)是![](https://www.zhihu.com/equation?tex=n%C3%971)列向量，![](https://www.zhihu.com/equation?tex=l)是标量。

解：上篇中已求得![](https://www.zhihu.com/equation?tex=%5Cnabla_W+l+%3D+%28%5Ctext%7Bsoftmax%7D%28W%5Cboldsymbol%7Bx%7D%29-%5Cboldsymbol%7By%7D%29%5Cboldsymbol%7Bx%7D%5ET)。为求![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_W+l)，先求微分：定义![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7Ba%7D+%3D+W%5Cboldsymbol%7Bx%7D)，![](https://www.zhihu.com/equation?tex=d%5Cnabla_W+l+%3D+%5Cleft%28%5Cfrac%7B%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5Codot+d%5Cboldsymbol%7Ba%7D%7D%7B%5Cboldsymbol%7B1%7D%5ET%5Cexp%28%5Cboldsymbol%7Ba%7D%29%7D+-+%5Cfrac%7B%5Cexp%28%5Cboldsymbol%7Ba%7D%29+%28%5Cboldsymbol%7B1%7D%5ET%28%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5Codot+d%5Cboldsymbol%7Ba%7D%29%29%7D%7B%28%5Cboldsymbol%7B1%7D%5ET%5Cexp%28%5Cboldsymbol%7Ba%7D%29%29%5E2%7D%5Cright%29+%5Cboldsymbol%7Bx%7D%5ET+%3D+%5Cleft%28+%5Cfrac%7B%5Ctext%7Bdiag%7D%28%5Cexp%28%5Cboldsymbol%7Ba%7D%29%29%7D%7B%5Cboldsymbol%7B1%7D%5ET%5Cexp%28%5Cboldsymbol%7Ba%7D%29%7D+-+%5Cfrac%7B%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5ET%7D%7B%28%5Cboldsymbol%7B1%7D%5ET%5Cexp%28%5Cboldsymbol%7Ba%7D%29%29%5E2%7D+%5Cright%29d%5Cboldsymbol%7Ba%7D+%5Cboldsymbol%7Bx%7D%5ET)![](https://www.zhihu.com/equation?tex=%3D%5Cleft%28%5Ctext%7Bdiag%7D%28%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%29+-+%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%5ET%5Cright%29d%5Cboldsymbol%7Ba%7D+%5Cboldsymbol%7Bx%7D%5ET)，注意这里化简去掉逐元素乘法，第一项中![](https://www.zhihu.com/equation?tex=%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5Codot+d%5Cboldsymbol%7Ba%7D+%3D+%5Ctext%7Bdiag%7D%28%5Cexp%28%5Cboldsymbol%7Ba%7D%29%29+d%5Cboldsymbol%7Ba%7D+)，第二项中![](https://www.zhihu.com/equation?tex=%5Cboldsymbol%7B1%7D%5ET%28%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5Codot+d%5Cboldsymbol%7Ba%7D%29+%3D+%5Cexp%28%5Cboldsymbol%7Ba%7D%29%5ETd%5Cboldsymbol%7Ba%7D)。定义矩阵![](https://www.zhihu.com/equation?tex=D%28%5Cboldsymbol%7Ba%7D%29+%3D+%5Ctext%7Bdiag%7D%28%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%29+-+%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%5Ctext%7Bsoftmax%7D%28%5Cboldsymbol%7Ba%7D%29%5ET)，![](https://www.zhihu.com/equation?tex=d%5Cnabla_W+l+%3DD%28%5Cboldsymbol%7Ba%7D%29d%5Cboldsymbol%7Ba%7D%5Cboldsymbol%7Bx%7D%5ET+%3D+D%28W%5Cboldsymbol%7Bx%7D%29dW+%5Cboldsymbol%7Bx%7D%5Cboldsymbol%7Bx%7D%5ET)，做向量化并使用矩阵乘法的技巧，得到![](https://www.zhihu.com/equation?tex=%5Cnabla%5E2_W+l+%3D+%28%5Cboldsymbol%7Bx%7D%5Cboldsymbol%7Bx%7D%5ET%29+%5Cotimes+D%28W%5Cboldsymbol%7Bx%7D%29)。

最后做个总结。我们发展了从**整体**出发的矩阵求导的技术，**导数与微分的联系是计算的枢纽**，标量对矩阵的导数与微分的联系是![](https://www.zhihu.com/equation?tex=df+%3D+%5Cmathrm%7Btr%7D%28%5Cnabla_X%5ET+f+dX%29)，先对 f 求微分，再使用迹技巧可求得导数，特别地，标量对向量的导数与微分的联系是![](https://www.zhihu.com/equation?tex=df+%3D+%5Cnabla%5ET_%7B%5Cboldsymbol%7Bx%7D%7Df+d%5Cboldsymbol%7Bx%7D)；矩阵对矩阵的导数与微分的联系是![](https://www.zhihu.com/equation?tex=%5Cmathrm%7Bvec%7D%28dF%29+%3D+%5Cfrac%7B%5Cpartial+F%7D%7B%5Cpartial+X%7D%5ET+%5Cmathrm%7Bvec%7D%28dX%29)，先对 F 求微分，再使用向量化的技巧可求得导数，特别地，向量对向量的导数与微分的联系是![](https://www.zhihu.com/equation?tex=d%5Cboldsymbol%7Bf%7D+%3D+%5Cfrac%7B%5Cpartial+%5Cboldsymbol%7Bf%7D%7D%7B%5Cpartial+%5Cboldsymbol%7Bx%7D%7D%5ETd%5Cboldsymbol%7Bx%7D)。

参考资料：

1.  张贤达. _矩阵分析与应用_. 清华大学出版社有限公司, 2004.
2.  Fackler, Paul L. "Notes on matrix calculus." _North Carolina State University_(2005).
3.  Petersen, Kaare Brandt, and Michael Syskind Pedersen. "The matrix cookbook." _Technical University of Denmark_ 7 (2008): 15.
4.  HU, Pili. "Matrix Calculus: Derivation and Simple Application." (2012).
5.  Magnus, Jan R., and Heinz Neudecker. "Matrix Differential Calculus with Applications in Statistics and Econometrics." Wiley, 2019.